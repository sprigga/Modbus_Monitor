services:
  redis:
    image: redis:7-alpine
    container_name: modbus_redis
    ports:
      # 原有的端口: 6380:6379
      # 修改為5位數冷門端口: 16380:6379
      - "16380:6379"
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: modbus_backend
    ports:
      # 原有的端口: 8000:8000
      # 修改為5位數冷門端口: 18000:18000
      - "18000:18000"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    # 註釋掉 .env 掛載,因為 Dockerfile 已經將 .env.new 複製到容器內
    # volumes:
    #   - ./.env:/app/.env
    depends_on:
      - redis
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend-vite
      dockerfile: Dockerfile
    # 保留原來的 image 設定作為備註,若需要直接使用已建構的映像檔可啟用
    # image: nginx:alpine
    container_name: modbus_frontend
    ports:
      # 原有的端口: 8081:80
      # 修改為5位數冷門端口: 18081:80
      - "18081:80"
    # 原本使用 volumes 掛載已建構的 dist 目錄,現在改為在建構時複製
    # volumes:
    #   - ./frontend-vite/dist:/usr/share/nginx/html
    #   - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  redis_data:
